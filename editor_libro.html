<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor de Libro ‚Äî Combinado</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="editor_libro.css">

  <!-- MathJax para LaTeX -->
  <script>
    MathJax = {
      tex: { inlineMath: [['\\(','\\)']], displayMath: [['\\[','\\]']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- jsPDF para exportar a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- L√≥gica principal -->
  <script src="editor_libro.js" defer></script>
</head>

<body>
  <!-- Bot√≥n flotante para mostrar/ocultar ChatBot -->
  <button id="toggleChatbotBtn" style="position:fixed;bottom:24px;right:24px;z-index:100;background:#2a4d7a;color:#fff;border-radius:50%;width:48px;height:48px;border:none;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:22px;cursor:pointer;">üí¨</button>

  <header>
    <h1>Generador de Libro</h1>
    <div class="sep"></div>
    <!-- ‚úî Botones conservados del archivo editor_de_libro -->
    <button id="btnPartes" title="Ver partes disponibles" type="button">Libro (partes)</button>
    <button id="btnDeshacer" disabled type="button">Deshacer</button>
    <button id="btnDescargar" title="Descargar HTML de solo lectura" type="button">Descargar HTML</button>
    <button id="btnDescargarPDF" title="Descargar PDF" type="button">Descargar PDF</button>
  </header>

  <div class="layout">
    <!-- PANEL IZQUIERDO: √çNDICE + gesti√≥n p√°ginas -->
    <aside class="toc">
      <h2>√çndice</h2>
      <!-- ‚úî Botonera de plantillas (del editor_de_libro) -->
      <div class="toolbar">
        <button id="btnAddPortada">Portada</button>
        <button id="btnAddPrefacio">Prefacio</button>
        <button id="btnAddCapitulo">Cap√≠tulo</button>
        <button id="btnAddSeccion">Secci√≥n</button>
        <button id="btnAddSubseccion">Subsecci√≥n</button>
      </div>

      <!-- Lista de p√°ginas (con acciones de edici√≥n) -->
      <ul id="pagesList" class="pages-list"></ul>
    </aside>

    <!-- PANEL DERECHO -->
    <main class="main">
      <div class="info">
        Haz clic en una p√°gina del √≠ndice para <b>editarla</b>. Usa la barra de ajustes para que <b>quepa m√°s contenido</b> por p√°gina.
        <span class="badge">LaTeX</span>
        <span class="badge">Im√°genes</span>
        <span class="badge">Simuladores [SIM:id]</span>
      </div>

      <div class="panel">
        <h3>Ajustes de composici√≥n</h3>
        <div class="controls-row">
          <div class="control">
            <label for="fontSize">Tama√±o de letra (px)</label>
            <input id="fontSize" type="range" min="12" max="22" value="16">
          </div>
          <div class="control">
            <label for="lineHeight">Interlineado</label>
            <input id="lineHeight" type="range" min="1.15" max="1.80" step="0.05" value="1.35">
          </div>
          <div class="control">
            <label for="margins">M√°rgenes (px)</label>
            <input id="margins
          </div>
          <div class="control">
            <label for="columns">Columnas</label>
            <input id="columns" type="range" min="1" max="2" step="1" value="1">
          </div>
          <div class="control">
            <label for="bgColor">Fondo</label>
            <input id="bgColor" type="color" value="#0f172a">
          </div>
          <div class="control">
            <label for="textColor">Texto</label>
            <input id="textColor" type="color" value="#e5e7eb">
          </div>
          <div class="control">
            <label for="paperColor">P√°gina</label>
            <input id="paperColor" type="color" value="#0a1120">
          </div>
        </div>
      </div>

      <!-- CSS din√°mico de composici√≥n (vista previa y export) -->
      <style id="liveTypeset"></style>

      <div class="panel">
        <h3>Vista previa</h3>
        <div id="vistaPrevia" class="output"></div>
      </div>

      <div class="panel">
        <h3>HTML exportable (solo lectura)</h3>
        <textarea id="htmlGenerado" class="codigo" readonly></textarea>
      </div>
    </main>
  </div>

  <!-- MODAL DE EDICI√ìN (potenciado con men√∫s LaTeX e imagen) -->
  <div id="modalEditorBg" class="modal-bg" hidden aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitulo">
      <h2 id="modalTitulo">Editar p√°gina</h2>

      <div class="row">
        <label for="inpTitulo"><b>T√≠tulo:</b></label>
        <input type="text" id="inpTitulo" placeholder="T√≠tulo de la p√°gina" />
      </div>

      <div class="row">
        <div class="toolbar-line">
          <span class="badge">Contenido (usa LaTeX con \( ... \) o \[ ... \])</span>
          <button id="btnMathSimbolos" type="button">S√≠mbolos ‚ñº</button>
          <button id="btnMathEqs" type="button">Estructuras ‚ñº</button>
          <button id="btnImagen" type="button">Imagen (JPG/PNG)</button>
          <input id="inpImagen" type="file" accept=".jpg,.jpeg,.png,image/jpeg,image/png" style="display:none">
          <div id="menuSimbolos" class="math-menu"></div>
          <div id="menuEqs" class="math-menu" style="left:140px;"></div>
        </div>

        <textarea id="inpContenido" placeholder="Escribe aqu√≠. Puedes usar HTML sencillo, LaTeX, im√°genes y tokens [SIM:id]."></textarea>
        <small>Tip: para <b>Portada</b> agrega t√≠tulo, autor, edici√≥n, editorial e imagen.</small>
      </div>

      <div class="buttons">
        <button id="btnCancelar" type="button">Cancelar</button>
        <button id="btnGuardar" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Popover simple para ‚ÄúLibro (partes)‚Äù -->
  <div id="partesPopover" class="popover" hidden>
    <div class="popover-inner">
      <b>Partes disponibles</b>
      <ul>
        <li>Portada</li>
        <li>Prefacio</li>
        <li>Cap√≠tulo</li>
        <li>Secci√≥n</li>
        <li>Subsecci√≥n</li>
      </ul>
      <p>Usa los botones del √≠ndice para a√±adirlas.</p>
      <button id="btnCerrarPartes">Cerrar</button>
    </div>
  </div>

  <!-- ChatBot Matem√°ticas/Probabilidad/Estad√≠stica -->
  <div id="chatbotBox" style="position:fixed;bottom:24px;right:24px;z-index:99;width:320px;max-width:95vw;display:none;">
    <div style="background:#fffaf3;border:1px solid #e0cfa2;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.12);padding:10px;">
      <div style="font-weight:bold;color:#2a4d7a;margin-bottom:6px;">ChatBot Matem√°ticas</div>
      <div id="chatbotMessages" style="height:180px;overflow-y:auto;font-size:14px;background:#f5e9d7;padding:8px;border-radius:8px;margin-bottom:8px;"></div>
      <form id="chatbotForm" style="display:flex;gap:6px;">
        <input id="chatbotInput" type="text" placeholder="Pregunta de matem√°ticas..." style="flex:1;padding:6px;border-radius:6px;border:1px solid #e0cfa2;">
        <button type="submit" style="background:#ffe4b5;color:#2a4d7a;border:1px solid #e0cfa2;border-radius:6px;padding:6px 12px;cursor:pointer;">Enviar</button>
      </form>
    </div>
  </div>

  <script>
  // ChatBot simple de matem√°ticas/probabilidad/estad√≠stica
  const chatbotMessages = document.getElementById('chatbotMessages');
  const chatbotForm = document.getElementById('chatbotForm');
  const chatbotInput = document.getElementById('chatbotInput');

  // Permite agregar la √∫ltima respuesta del chatbot como una nueva p√°gina en el libro
  let lastBotAnswer = "";

  function chatbotReply(msg) {
    msg = msg.trim().toLowerCase();

    // Saludos y frases comunes
    if (msg.match(/^(hola|buenos d√≠as|buenas tardes|buenas noches|hey|holi|saludos)$/)) return "¬°Hola! ¬øEn qu√© puedo ayudarte hoy?";
    if (msg.includes('¬øc√≥mo est√°s') || msg.includes('como estas')) return "¬°Estoy bien, gracias! ¬øEn qu√© tema de matem√°ticas, probabilidad o estad√≠stica te ayudo?";
    if (msg.includes('gracias')) return "¬°De nada! Si tienes otra pregunta, aqu√≠ estoy.";
    if (msg.includes('adi√≥s') || msg.includes('hasta luego') || msg.includes('nos vemos')) return "¬°Hasta luego! Vuelve cuando quieras preguntar algo.";
    if (msg.includes('qui√©n eres') || msg.includes('quien eres')) return "Soy tu asistente virtual de matem√°ticas, probabilidad y estad√≠stica.";
    if (msg.includes('qu√© puedes hacer') || msg.includes('que puedes hacer')) return "Puedo responder preguntas b√°sicas de matem√°ticas, probabilidad y estad√≠stica. Prueba con f√≥rmulas, definiciones o c√°lculos simples.";

    // Matem√°ticas b√°sicas
    if (msg.includes('derivada de x^2')) return "La derivada de x¬≤ es 2x.";
    if (msg.includes('derivada de sen(x)')) return "La derivada de sen(x) es cos(x).";
    if (msg.includes('derivada de cos(x)')) return "La derivada de cos(x) es -sen(x).";
    if (msg.includes('integral de x')) return "La integral de x respecto a x es (1/2)x¬≤ + C.";
    if (msg.includes('integral de sen(x)')) return "La integral de sen(x) es -cos(x) + C.";
    if (msg.includes('integral de cos(x)')) return "La integral de cos(x) es sen(x) + C.";
    if (msg.includes('teorema de pitagoras')) return "El teorema de Pit√°goras dice: a¬≤ + b¬≤ = c¬≤.";
    if (msg.includes('area de un circulo')) return "El √°rea de un c√≠rculo es œÄr¬≤.";
    if (msg.includes('perimetro de un circulo')) return "El per√≠metro de un c√≠rculo es 2œÄr.";
    if (msg.includes('probabilidad')) return "La probabilidad mide la posibilidad de que ocurra un evento. Se calcula como casos favorables dividido por casos posibles.";
    if (msg.includes('media') || msg.includes('promedio')) return "La media es la suma de los valores dividida entre la cantidad de valores.";
    if (msg.includes('mediana')) return "La mediana es el valor central de un conjunto ordenado.";
    if (msg.includes('moda')) return "La moda es el valor que m√°s veces se repite en un conjunto de datos.";
    if (msg.includes('varianza')) return "La varianza mide la dispersi√≥n de los datos respecto a la media.";
    if (msg.includes('desviacion estandar')) return "La desviaci√≥n est√°ndar es la ra√≠z cuadrada de la varianza.";
    if (msg.includes('binomial')) return "La distribuci√≥n binomial modela el n√∫mero de √©xitos en n ensayos independientes.";
    if (msg.includes('normal')) return "La distribuci√≥n normal es una curva sim√©trica en forma de campana.";
    if (msg.includes('cuartiles')) return "Los cuartiles dividen un conjunto de datos ordenados en cuatro partes iguales.";
    if (msg.includes('percentil')) return "El percentil indica el valor bajo el cual se encuentra un porcentaje de datos.";
    if (msg.includes('histograma')) return "Un histograma es una gr√°fica de barras que representa la frecuencia de los datos agrupados en intervalos.";
    if (msg.includes('regresion lineal')) return "La regresi√≥n lineal busca ajustar una recta a un conjunto de datos para modelar la relaci√≥n entre dos variables.";
    if (msg.includes('correlacion')) return "La correlaci√≥n mide la relaci√≥n entre dos variables, puede ser positiva, negativa o nula.";
    if (msg.match(/cuanto es (\d+)\s*[\+\-]\s*(\d+)/)) {
      const m = msg.match(/cuanto es (\d+)\s*([\+\-])\s*(\d+)/);
      const a = parseInt(m[1]), op = m[2], b = parseInt(m[3]);
      return `El resultado es ${op === '+' ? a + b : a - b}.`;
    }
    if (msg.match(/cuanto es (\d+)\s*\*\s*(\d+)/)) {
      const m = msg.match(/cuanto es (\d+)\s*\*\s*(\d+)/);
      return `El resultado es ${parseInt(m[1]) * parseInt(m[2])}.`;
    }
    if (msg.match(/cuanto es (\d+)\s*\/\s*(\d+)/)) {
      const m = msg.match(/cuanto es (\d+)\s*\/\s*(\d+)/);
      if (parseInt(m[2]) === 0) return "No se puede dividir por cero.";
      return `El resultado es ${(parseInt(m[1]) / parseInt(m[2])).toFixed(3)}.`;
    }

    // Detecci√≥n de creaci√≥n de partes del libro
    if (msg.includes('crear portada')) {
      autoAddBookPart('portada');
      return "He creado una portada para tu libro.";
    }
    if (msg.includes('crear prefacio')) {
      autoAddBookPart('prefacio');
      return "He creado un prefacio para tu libro.";
    }
    if (msg.includes('crear cap√≠tulo') || msg.includes('crear capitulo')) {
      autoAddBookPart('capitulo');
      return "He creado un cap√≠tulo para tu libro.";
    }
    if (msg.includes('crear secci√≥n') || msg.includes('crear seccion')) {
      autoAddBookPart('seccion');
      return "He creado una secci√≥n para tu libro.";
    }
    if (msg.includes('crear subsecci√≥n') || msg.includes('crear subseccion')) {
      autoAddBookPart('subseccion');
      return "He creado una subsecci√≥n para tu libro.";
    }

    // Respuesta por defecto
    lastBotAnswer = "No s√© la respuesta exacta, pero puedo ayudarte con preguntas b√°sicas de matem√°ticas, probabilidad y estad√≠stica. Prueba con f√≥rmulas, definiciones o c√°lculos simples.";
    return lastBotAnswer;
  }

  // Agrega autom√°ticamente una parte al libro seg√∫n el tipo
  function autoAddBookPart(tipo) {
    if (!window.pages || !Array.isArray(window.pages)) return;
    let plantilla;
    switch(tipo) {
      case 'portada':
        plantilla = {
          id: "p" + (window.pages.length + 1),
          tipo: "portada",
          titulo: "Portada",
          contenido: `<div class="portada"><h1 style="text-align:center;">Portada</h1><p style="text-align:center;">Autor: ChatBot</p><p style="text-align:center;">Edici√≥n: 1¬™</p><p style="text-align:center;">Fecha: ${new Date().toISOString().slice(0,10)}</p><p style="text-align:center;">Editorial: ChatBot Editorial</p></div>`
        };
        break;
      case 'prefacio':
        plantilla = {
          id: "p" + (window.pages.length + 1),
          tipo: "generico",
          titulo: "Prefacio",
          contenido: `<p>Bienvenido al libro. Este prefacio fue generado autom√°ticamente por el ChatBot.</p>`
        };
        break;
      case 'capitulo':
        plantilla = {
          id: "p" + (window.pages.length + 1),
          tipo: "generico",
          titulo: "Cap√≠tulo 1",
          contenido: `<h3>Introducci√≥n</h3><p>Este es el primer cap√≠tulo, generado por el ChatBot.</p>`
        };
        break;
      case 'seccion':
        plantilla = {
          id: "p" + (window.pages.length + 1),
          tipo: "generico",
          titulo: "Secci√≥n",
          contenido: `<h4>Tema</h4><p>Esta secci√≥n fue creada autom√°ticamente por el ChatBot.</p>`
        };
        break;
      case 'subseccion':
        plantilla = {
          id: "p" + (window.pages.length + 1),
          tipo: "generico",
          titulo: "Subsecci√≥n",
          contenido: `<h5>Subtema</h5><p>Subsecci√≥n generada por el ChatBot.</p>`
        };
        break;
      default:
        return;
    }
    window.pages.push(plantilla);
    if (window.renderPagesList) window.renderPagesList();
    if (window.renderPreview) window.renderPreview();
    if (window.dumpHTML) window.dumpHTML();
  }

  function addChatbotMsg(text, from='user') {
    const div = document.createElement('div');
    div.style.marginBottom = '6px';
    div.style.textAlign = from === 'user' ? 'right' : 'left';
    div.innerHTML = `<span style="background:${from==='user'?'#ffe4b5':'#e0cfa2'};padding:4px 8px;border-radius:8px;display:inline-block;">${text}</span>`;
    chatbotMessages.appendChild(div);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    if (from === 'bot') lastBotAnswer = text;
  }

  chatbotForm.addEventListener('submit', function(e){
    e.preventDefault();
    const q = chatbotInput.value.trim();
    if (!q) return;
    addChatbotMsg(q, 'user');
    setTimeout(()=>{
      const answer = chatbotReply(q);
      addChatbotMsg(answer, 'bot');
    }, 400);
    chatbotInput.value = '';
  });

  // Bot√≥n para agregar la √∫ltima respuesta del bot al libro
  const addToBookBtn = document.createElement('button');
  addToBookBtn.textContent = "Agregar respuesta al libro";
  addToBookBtn.style = "margin-top:8px;background:#6fcf97;color:#2a4d7a;border:1px solid #e0cfa2;border-radius:6px;padding:6px 12px;cursor:pointer;width:100%";
  document.getElementById('chatbotBox').querySelector('div').appendChild(addToBookBtn);

  addToBookBtn.onclick = function() {
    if (!lastBotAnswer) {
      alert("No hay respuesta para agregar.");
      return;
    }
    // Usa el editor_libro.js global para agregar una p√°gina
    if (window.pages && Array.isArray(window.pages)) {
      window.pages.push({
        id: "p" + (window.pages.length + 1),
        tipo: "generico",
        titulo: "Respuesta del ChatBot",
        contenido: `<p>${lastBotAnswer}</p>`
      });
      if (window.renderPagesList) window.renderPagesList();
      if (window.renderPreview) window.renderPreview();
      if (window.dumpHTML) window.dumpHTML();
      alert("Respuesta agregada al libro.");
    } else {
      alert("No se pudo agregar la respuesta. Recarga la p√°gina si el libro no aparece.");
    }
  };

  // Mensaje de bienvenida
  addChatbotMsg("¬°Hola! Soy tu asistente de matem√°ticas, probabilidad y estad√≠stica. Preg√∫ntame algo.", 'bot');

  // Mejorar el control de interlineado: muestra el valor actual y actualiza en tiempo real
  const lineHeightInput = document.getElementById('lineHeight');
  const lineHeightLabel = document.querySelector('label[for="lineHeight"]');
  if (lineHeightInput && lineHeightLabel) {
    // Crea un span para mostrar el valor
    let lhValueSpan = document.createElement('span');
    lhValueSpan.id = 'lhValueSpan';
    lhValueSpan.style = 'margin-left:8px;font-weight:bold;color:#2a4d7a;';
    lhValueSpan.textContent = lineHeightInput.value;
    lineHeightLabel.appendChild(lhValueSpan);

    // Actualiza el valor en tiempo real
    lineHeightInput.addEventListener('input', function() {
      lhValueSpan.textContent = this.value;
      // Dispara el evento para actualizar la vista previa y el HTML generado
      if (window.applyLiveTypeset) window.applyLiveTypeset();
      if (window.renderPreview) window.renderPreview();
      if (window.dumpHTML) window.dumpHTML();
    });
  }

  // Mostrar/ocultar ChatBot
  const chatbotBox = document.getElementById('chatbotBox');
  const toggleChatbotBtn = document.getElementById('toggleChatbotBtn');
  let chatbotVisible = false;
  toggleChatbotBtn.onclick = function() {
    chatbotVisible = !chatbotVisible;
    chatbotBox.style.display = chatbotVisible ? '' : 'none';
    toggleChatbotBtn.title = chatbotVisible ? 'Ocultar ChatBot' : 'Mostrar ChatBot';
  };
  </script>
</body>
</html>
